# å¯å˜é•¿åº¦æ•°æ®åŒ…å¤„ç†æ¼”ç¤º

## ğŸ¯ æ¼”ç¤ºç›®æ ‡

å±•ç¤ºå¦‚ä½•ä½¿ç”¨æ–°çš„ç¯å½¢ç¼“å†²åŒºç³»ç»Ÿæ¥å¤„ç†ä¸åŒç±»å‹çš„ä¸²å£æ•°æ®åŒ…ï¼Œç¡®ä¿åªæœ‰å®Œæ•´çš„æ•°æ®åŒ…æ‰ä¼šè¢«å¤„ç†ã€‚

## ğŸ“¦ æ”¯æŒçš„æ•°æ®åŒ…ç±»å‹

### 1. å¼€æœºå“åº”åŒ… (4å­—èŠ‚)
```
å­—èŠ‚: 0x68 0x00 0x01 0x55
è¯´æ˜: åŒ…å¤´ + åŒ…é•¿åº¦(1) + å‘½ä»¤ç±»å‹(å¼€æœºå“åº”)
```

### 2. æŸ¥è¯¢IDå“åº”åŒ… (7å­—èŠ‚)
```
å­—èŠ‚: 0x68 0x00 0x04 0x02 0x01 0x02 0x03
è¯´æ˜: åŒ…å¤´ + åŒ…é•¿åº¦(4) + å‘½ä»¤ç±»å‹(æŸ¥è¯¢ID) + è®¾å¤‡ID(3å­—èŠ‚)
```

### 3. å®šä½æ•°æ®åŒ… (45å­—èŠ‚)
```
å­—èŠ‚: 0x68 0x00 0x2A 0xCC [42å­—èŠ‚å®šä½æ•°æ®]
è¯´æ˜: åŒ…å¤´ + åŒ…é•¿åº¦(42) + å‘½ä»¤ç±»å‹(å®šä½æ•°æ®) + å®šä½ä¿¡æ¯
```

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬è®¾ç½®
```java
// åˆ›å»ºUSBSerialManagerå®ä¾‹
USBSerialManager manager = new USBSerialManager(pluginContext, hostContext);

// è®¾ç½®æ•°æ®æ¥æ”¶ç›‘å¬å™¨
manager.setListener(new USBSerialListener() {
    @Override
    public void onDataReceived(byte[] data) {
        // data ä¿è¯æ˜¯å®Œæ•´çš„æ•°æ®åŒ…
        handleCompletePacket(data);
    }
    
    @Override
    public void onDeviceConnected(UsbDevice device) {
        Log.d(TAG, "Device connected: " + device.getDeviceName());
    }
    
    @Override
    public void onDeviceDisconnected() {
        Log.d(TAG, "Device disconnected");
    }
    
    @Override
    public void onError(Exception error) {
        Log.e(TAG, "Serial error", error);
    }
});
```

### æ•°æ®åŒ…å¤„ç†
```java
private void handleCompletePacket(byte[] packet) {
    if (packet.length < 4) {
        Log.w(TAG, "Packet too short: " + packet.length + " bytes");
        return;
    }
    
    // éªŒè¯åŒ…å¤´
    int header = ((packet[0] & 0xFF) << 8) | (packet[1] & 0xFF);
    if (header != 0x0068) {
        Log.w(TAG, "Invalid packet header: 0x" + Integer.toHexString(header).toUpperCase());
        return;
    }
    
    // è§£æåŒ…ä¿¡æ¯
    int packetDataLength = packet[2] & 0xFF;
    int commandType = packet[3] & 0xFF;
    int totalLength = packetDataLength + 3;
    
    Log.d(TAG, String.format("Packet: DataLen=%d, Cmd=0x%02X, Total=%d", 
            packetDataLength, commandType, totalLength));
    
    // æ ¹æ®å‘½ä»¤ç±»å‹å¤„ç†
    switch (commandType) {
        case 0x55: // å¼€æœºå“åº”
            handlePowerOnResponse(packet);
            break;
            
        case 0x02: // æŸ¥è¯¢IDå“åº”
            handleIdQueryResponse(packet);
            break;
            
        case 0xCC: // å®šä½æ•°æ®
            handleLocationData(packet);
            break;
            
        default:
            Log.w(TAG, "Unknown command type: 0x" + Integer.toHexString(commandType).toUpperCase());
            break;
    }
}
```

### å…·ä½“å¤„ç†å‡½æ•°
```java
private void handlePowerOnResponse(byte[] packet) {
    Log.d(TAG, "ğŸ”‹ Device power-on response received");
    // å¤„ç†å¼€æœºå“åº”é€»è¾‘
    // ä¾‹å¦‚ï¼šæ›´æ–°UIçŠ¶æ€ã€å‘é€æŸ¥è¯¢å‘½ä»¤ç­‰
}

private void handleIdQueryResponse(byte[] packet) {
    Log.d(TAG, "ğŸ†” Device ID query response received");
    
    if (packet.length >= 7) {
        // æå–è®¾å¤‡ID (å­—èŠ‚4-6)
        byte[] deviceId = new byte[3];
        System.arraycopy(packet, 4, deviceId, 0, 3);
        
        String idString = String.format("%02X%02X%02X", 
                deviceId[0] & 0xFF, deviceId[1] & 0xFF, deviceId[2] & 0xFF);
        Log.d(TAG, "Device ID: " + idString);
        
        // å¤„ç†è®¾å¤‡IDé€»è¾‘
    }
}

private void handleLocationData(byte[] packet) {
    Log.d(TAG, "ğŸ“ Location data received");
    
    if (packet.length >= 45) {
        // æå–å®šä½æ•°æ® (å­—èŠ‚4-45)
        byte[] locationData = new byte[42];
        System.arraycopy(packet, 4, locationData, 0, 42);
        
        // è§£æå®šä½ä¿¡æ¯
        parseLocationInfo(locationData);
    }
}

private void parseLocationInfo(byte[] data) {
    // æ ¹æ®ä½ çš„å®šä½æ•°æ®æ ¼å¼è§£æ
    // ä¾‹å¦‚ï¼šç»çº¬åº¦ã€æ—¶é—´æˆ³ã€çŠ¶æ€ä¿¡æ¯ç­‰
    Log.d(TAG, "Location data: " + data.length + " bytes");
    
    // è¿™é‡Œæ·»åŠ å…·ä½“çš„å®šä½æ•°æ®è§£æé€»è¾‘
    // ä¾‹å¦‚ï¼š
    // double latitude = parseLatitude(data);
    // double longitude = parseLongitude(data);
    // long timestamp = parseTimestamp(data);
}
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### è¿è¡Œæµ‹è¯•
```java
// åœ¨éœ€è¦çš„åœ°æ–¹è°ƒç”¨æµ‹è¯•
RingBufferTest.runAllTests();
```

### æµ‹è¯•è¾“å‡ºç¤ºä¾‹
```
ğŸ§ª Starting RingBuffer basic functionality test
âœ… Test 1 - Written 4 bytes
âœ… Test 1 - Has complete packet: 4 bytes
âœ… Test 1 - Successfully read complete packet
âœ… Test 1 - Packet header verified
ğŸ§ª Test 2 - Testing fragmented packet writing
ğŸ“ Written first part (32 bytes)
âœ… Test 2 - Has complete packet after first part: false
ğŸ“ Written second part (13 bytes)
âœ… Test 2 - Has complete packet after second part: 45 bytes
âœ… Test 2 - Successfully read fragmented packet
âœ… Test 2 - Packet structure verified
ğŸ§ª Test 3 - Testing multiple packet types
ğŸ“ Written power-on packet (4 bytes)
ğŸ“ Written ID query packet (7 bytes)
ğŸ“ Written location packet (45 bytes)
ğŸ“¦ Read packet 1 (4 bytes)
  â†’ Power-on response
ğŸ“¦ Read packet 2 (7 bytes)
  â†’ ID query response
ğŸ“¦ Read packet 3 (45 bytes)
  â†’ Location data
âœ… Test 3 - Successfully processed 3 packets
ğŸ‰ RingBuffer test completed
```

## ğŸ“Š æ€§èƒ½ç‰¹ç‚¹

### å¤„ç†æ•ˆç‡
- **è‡ªåŠ¨è¯†åˆ«**: æ— éœ€æ‰‹åŠ¨æŒ‡å®šæ•°æ®åŒ…é•¿åº¦
- **å®Œæ•´æ€§ä¿è¯**: åªæœ‰å®Œæ•´æ•°æ®åŒ…æ‰ä¼šè¢«å¤„ç†
- **åˆ†ç‰‡å¤„ç†**: è‡ªåŠ¨å¤„ç†åˆ†ç‰‡æ¥æ”¶çš„æ•°æ®
- **å†…å­˜ä¼˜åŒ–**: æ™ºèƒ½çš„ç¼“å†²åŒºç®¡ç†

### é”™è¯¯å¤„ç†
- **åŒ…å¤´éªŒè¯**: è‡ªåŠ¨éªŒè¯åŒ…å¤´æ ‡è¯†
- **é•¿åº¦æ£€æŸ¥**: ç¡®ä¿æ•°æ®åŒ…é•¿åº¦æ­£ç¡®
- **å¼‚å¸¸å®‰å…¨**: å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶
- **æ—¥å¿—è®°å½•**: è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯

## ğŸ‰ ä¼˜åŠ¿æ€»ç»“

1. **è‡ªåŠ¨åŒ–å¤„ç†**: æ— éœ€æ‰‹åŠ¨ç®¡ç†æ•°æ®åŒ…è¾¹ç•Œ
2. **ç±»å‹è¯†åˆ«**: è‡ªåŠ¨è¯†åˆ«ä¸åŒç±»å‹çš„æ•°æ®åŒ…
3. **ç¨³å®šæ€§**: é¿å…åˆ†ç‰‡æ•°æ®å¯¼è‡´çš„å¤„ç†é”™è¯¯
4. **æ‰©å±•æ€§**: æ˜“äºæ·»åŠ æ–°çš„æ•°æ®åŒ…ç±»å‹
5. **è°ƒè¯•å‹å¥½**: ä¸°å¯Œçš„æ—¥å¿—å’ŒçŠ¶æ€ä¿¡æ¯

---

**ä½¿ç”¨å»ºè®®**: 
- åœ¨ `onDataReceived` å›è°ƒä¸­ç›´æ¥å¤„ç†å®Œæ•´æ•°æ®åŒ…
- ä½¿ç”¨å‘½ä»¤ç±»å‹æ¥åŒºåˆ†ä¸åŒçš„æ•°æ®åŒ…
- åˆ©ç”¨æ—¥å¿—è¾“å‡ºæ¥è°ƒè¯•æ•°æ®åŒ…å¤„ç†è¿‡ç¨‹
- æ ¹æ®å®é™…éœ€æ±‚æ‰©å±•æ•°æ®åŒ…è§£æé€»è¾‘
