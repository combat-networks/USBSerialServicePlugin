# 手台ID查询功能实现说明

## 🎯 功能概述

已成功将USB串口插件的Test按钮修改为"手台ID"按钮，并实现了完整的手台ID查询功能。

## 📋 实现的功能

### 1. ✅ 界面修改
- **按钮文本**: Test → 手台ID
- **新增显示**: 添加了专门的手台ID显示区域
- **状态更新**: 实时显示查询到的手台ID信息

### 2. ✅ 数据包发送功能
- **查询命令**: 发送 `0x68 0x00 0x01 0x02` 数据包
- **包结构**:
  - 字节0: `0x68` (包头标识低字节)
  - 字节1: `0x00` (包头标识高字节)
  - 字节2: `0x01` (包长度)
  - 字节3: `0x02` (查询设备ID命令)

### 3. ✅ 响应数据包解析
- **响应格式**: `0x68 0x00 0x04 0x02 ID1 ID2 ID3`
- **ID解析**: 小端序解析 (字节4-6)
- **显示格式**: 十进制 + 十六进制格式

### 4. ✅ 超时处理机制
- **超时时间**: 500ms
- **超时提示**: 详细的错误检查建议
- **状态管理**: 防止重复查询

### 5. ✅ 自动查询功能
- **触发条件**: 收到开机响应包 (0x55)
- **延迟查询**: 开机后100ms自动查询ID
- **智能处理**: 避免冲突和重复

## 🔧 核心代码实现

### 查询ID数据包发送
```java
private void queryDeviceId() {
    byte[] queryPacket = new byte[4];
    queryPacket[0] = (byte) 0x68;  // 包头标识低字节
    queryPacket[1] = (byte) 0x00;  // 包头标识高字节
    queryPacket[2] = (byte) 0x01;  // 包长度
    queryPacket[3] = (byte) 0x02;  // 命令类型：查询设备ID
    
    usbSerialManager.sendData(queryPacket);
    // 设置500ms超时处理
}
```

### ID响应解析
```java
private void handleIdResponse(byte[] data) {
    // 小端序解析设备ID (字节4-6)
    long localId = (data[4] & 0xFF);        // 最低字节
    localId |= ((data[5] & 0xFF) << 8);    // 中间字节
    localId |= ((data[6] & 0xFF) << 16);   // 最高字节
    
    // 更新UI显示
    tvDeviceId.setText("手台ID: " + localId + " (0x" + String.format("%06X", localId) + ")");
}
```

## 📱 用户界面更新

### 新增显示元素
- **手台ID显示**: 绿色粗体文字，显示查询到的ID
- **格式**: `手台ID: 123456 (0x01E240)`
- **状态**: 未查询时显示"手台ID: 未查询"

### 按钮功能
- **手台ID按钮**: 点击发送查询命令
- **防重复**: 查询中时提示"正在等待手台ID响应"

## 🔄 工作流程

### 手动查询流程
1. 用户点击"手台ID"按钮
2. 发送查询ID数据包 `0x68 0x00 0x01 0x02`
3. 启动500ms超时定时器
4. 等待手台响应
5. 解析响应数据包获取ID
6. 更新界面显示

### 自动查询流程
1. 手台开机发送开机响应 `0x68 0x00 0x01 0x55`
2. 检测到开机响应后延迟100ms
3. 自动发送查询ID命令
4. 解析并显示手台ID

## ⚠️ 错误处理

### 超时处理
- **超时时间**: 500ms
- **错误提示**: 
  - "查询手台ID超时（500ms）"
  - "请检查：手台是否已开机、串口连接是否正常、手台是否支持ID查询命令"

### 数据包验证
- **长度检查**: 响应包必须≥7字节
- **格式验证**: 包头必须是0x0068
- **命令验证**: 响应命令必须是0x02

## 🎉 功能特点

### ✅ 完全按照规范实现
- **数据包格式**: 严格按照提供的C++代码规范
- **字节序处理**: 正确的小端序解析
- **超时机制**: 500ms超时处理
- **自动查询**: 开机后自动查询ID

### ✅ 用户体验优化
- **实时反馈**: 详细的日志输出
- **状态显示**: 清晰的手台ID显示
- **错误提示**: 友好的错误信息
- **防重复**: 避免重复查询

### ✅ 代码质量
- **模块化设计**: 独立的方法处理不同功能
- **错误处理**: 完善的异常处理机制
- **状态管理**: 清晰的状态变量管理
- **UI更新**: 线程安全的主线程更新

## 🚀 使用说明

1. **连接手台**: 使用Scan和Connect按钮连接手台
2. **查询ID**: 点击"手台ID"按钮查询设备ID
3. **自动查询**: 手台开机后会自动查询ID
4. **查看结果**: 在绿色文字区域查看手台ID
5. **错误处理**: 超时或错误时查看日志提示

## 📊 测试建议

### 功能测试
- [ ] 手动查询手台ID
- [ ] 开机自动查询ID
- [ ] 超时处理测试
- [ ] 错误数据包处理
- [ ] 重复查询防护

### 界面测试
- [ ] 手台ID显示正确
- [ ] 状态更新及时
- [ ] 错误提示友好
- [ ] 日志输出详细

---

**实现完成时间**: 2024年12月
**功能状态**: ✅ 完全实现
**测试状态**: 🔄 待测试
